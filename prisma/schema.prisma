generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url  	    = env("DATABASE_URL")
  // uncomment next line if you use Prisma <5.10
  // directUrl = env("DATABASE_URL_UNPOOLED")
}

model inbounds {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lead_id      String?  @db.Uuid
  pipefy_id    String?  @unique
  gclid        String?
  fbclid       String?
  ctwaclid     String?
  utm_source   String?
  utm_medium   String?
  utm_campaign String?
  utm_term     String?
  utm_content  String?
  status       String?


  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  leads        leads?   @relation(fields: [lead_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  sales        sales[]

  @@index([created_at])
  @@index([lead_id, created_at])
  @@index([status])
  @@index([utm_source, utm_medium, utm_campaign, utm_term, utm_content])
}

model leads {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String?
  phone           String?           @unique
  remote_jid      String?           @unique
  instagram       String?           @unique
  mail            String?

  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @updatedAt @db.Timestamptz(6)

  inbounds        inbounds[]
  sales_analytics sales_analytics[]
  lead_messages   lead_messages[]

  @@index([created_at])
}

model sales {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inbound_id    String?   @db.Uuid
  fbtrace_id    String?
  description   Json?
  service_count Int?
  amount        Decimal?  @db.Decimal(12, 2)

  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  
  inbounds      inbounds? @relation(fields: [inbound_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([inbound_id])
  @@index([created_at])
  @@index([fbtrace_id])
}

model sales_analytics {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lead_id       String?  @db.Uuid  
  qualy_audit   String?
  time_audit    String?
  
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  leads       leads?   @relation(fields: [lead_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([lead_id])
  @@index([created_at])
}

model lead_messages {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lead_id       String   @db.Uuid
  message_id    String?  @unique
  author_number String?
  author_role   String?
  message_type  String?
  body          String?
  raw_payload   Json?
  sent_at       DateTime? @db.Timestamptz(6)

  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  leads         leads    @relation(fields: [lead_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([lead_id, sent_at])
  @@index([message_type])
}
